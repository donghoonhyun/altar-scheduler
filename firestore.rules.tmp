rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ”’ í—¬í¼ í•¨ìˆ˜
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    function isSuperAdmin() {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isSignedIn() && exists(userPath) && get(userPath).data.roles.hasAny(['superadmin']);
    }

    // 1ï¸âƒ£ Users: í”„ë¡œí•„ì€ ëˆ„êµ¬ë‚˜ ì½ê¸° ê°€ëŠ¥, ìˆ˜ì •ì€ ë³¸ì¸ ë˜ëŠ” ìŠˆí¼ì–´ë“œë¯¼
    match /users/{userId} {
      allow read: if true;
      allow create: if true; // ê°œë°œ ìš© ì‹œë”© í—ˆìš©
      allow update, delete: if true; // ê°œë°œ ìš© ì‹œë”© í—ˆìš©
    }

    // 1ï¸âƒ£.1 Verbum Users Data (NEW)
    // Verbum ì•± ì‚¬ìš©ì ë°ì´í„°: ë³¸ì¸ ë°ì´í„°ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
    match /users_verbum/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }

    // 2ï¸âƒ£ Parishes: ì½ê¸° ì „ìš© (ê³µê°œ ì •ë³´), ì“°ê¸°ëŠ” ìŠˆí¼ì–´ë“œë¯¼ë§Œ
    match /parishes/{parishCode} {
      allow read: if true;
      allow write: if true; // ê°œë°œ ì¤‘ ë°ì´í„° ì‹œë”©ì„ ìœ„í•´ í—ˆìš©
    }


    // 3.9 Dashboard News (ê³µì§€ì‚¬í•­)
    match /dashboard_news/{newsId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // 3.10 System Notification Logs (ì‹œìŠ¤í…œ ì•Œë¦¼ ë¡œê·¸)
    match /system_notification_logs/{logId} {
      allow read: if isSuperAdmin();
    }

    // 3.10.1 FCM Logs (logs/fcm_logs/items/*)
    match /logs/{logType}/items/{logId} {
      allow read: if isSuperAdmin();
    }

    // ğŸ”” Notifications (ì•Œë¦¼)
    match /notifications/{notificationId} {
      // ë³¸ì¸ì˜ ì•Œë¦¼ì´ê±°ë‚˜ ìŠˆí¼ì–´ë“œë¯¼ì´ë©´ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read: if isSignedIn() && (resource.data.uid == request.auth.uid || isSuperAdmin());
      allow create: if isSignedIn(); // í…ŒìŠ¤íŠ¸ ìƒì„±ì„ ìœ„í•´ ë¡œê·¸ì¸ ì‚¬ìš©ì í—ˆìš©
      allow update, delete: if isSignedIn() && (resource.data.uid == request.auth.uid || isSuperAdmin());
    }

    match /daily_verses/{verseId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }
    
    match /sources/daily_missa/dates/{dateKey} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }

    match /sources/daily_saints/dates/{dateKey} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }
    
    match /sources/saints/items/{saintId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }

    // ğŸ’¡ Settings Collection (AI Config, etc)
    match /settings/{document=**} {
      allow read, write: if true; 
    }

    // 3.11 System Settings (AI í”„ë¡¬í”„íŠ¸ ì„¤ì • ë“±)
    match /system_settings/{settingId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }
    
    // ğŸš© 4. Ordo Apps (Deprecated Path): ë©”íƒ€ë°ì´í„°ëŠ” ëˆ„êµ¬ë‚˜ ì½ê¸° ê°€ëŠ¥
    match /apps/{appId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // ğŸš© 5. Master Data (New Location)
    match /sources/master_datas {
        // Parishes
        match /parishes/{parishCode} {
            allow read: if true;
            allow write: if true; // ê°œë°œ í¸ì˜ìƒ í—ˆìš© (Productionì—ì„œëŠ” isSuperAdmin() ê¶Œì¥)
        }
        
        // Apps
        match /apps/{appId} {
            allow read: if true;
            allow write: if isSignedIn();
        }

        // Dioceses
        match /dioceses/{dioceseCode} {
            allow read: if true;
            allow write: if isSuperAdmin();
        }
    }

    // ğŸš© 6. User Installed Apps: ë³¸ì¸ë§Œ ê´€ë¦¬ ê°€ëŠ¥
    match /users/{userId}/installed_apps/{appId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && (
        // ì„¤ì¹˜í•˜ë ¤ëŠ” ì•±ì´ admin ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° superadmin ê¶Œí•œ í•„ìš”
        // (ìƒˆë¡œìš´ ê²½ë¡œ ìš°ì„  í™•ì¸, ì—†ìœ¼ë©´ ê¸°ì¡´ ê²½ë¡œ í™•ì¸ - ë§ˆì´ê·¸ë ˆì´ì…˜ ê³¼ë„ê¸° ì§€ì›)
        (exists(/databases/$(database)/documents/sources/master_datas/apps/$(appId)) && 
         get(/databases/$(database)/documents/sources/master_datas/apps/$(appId)).data.category != 'admin') ||
        
        (!exists(/databases/$(database)/documents/sources/master_datas/apps/$(appId)) && 
         get(/databases/$(database)/documents/apps/$(appId)).data.category != 'admin') ||
         
        isSuperAdmin()
      );
    }

    // ========================================
    // ğŸ“‚ 7. ALTAR SCHEDULER (v1)
    // ========================================
    match /app_altar/v1 {
      // 7.1 Memberships: ì—­í•  ì •ë³´ (ë³¸ì¸ ê²ƒë§Œ ì¡°íšŒ/ë“±ë¡)
      match /memberships/{membershipId} {
        allow read: if isSignedIn() && (resource.data.uid == request.auth.uid || isSuperAdmin());
        allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
        allow update, delete: if isSignedIn(); // ê´€ë¦¬ì/í”Œë˜ë„ˆ ê¶Œí•œìš© (ê°œë°œ/ì„ì‹œìš´ì˜ ì¤‘ í—ˆìš©) 
      }

      // 7.2 Server Groups: ê·¸ë£¹ ì •ë³´
      match /server_groups/{sgId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn(); // ê°œë°œ ì¤‘ ë§ˆì´ê·¸ë ˆì´ì…˜ ë“±ì„ ìœ„í•´ ì„ì‹œ í—ˆìš©

        // 7.2.1 Members: ë³µì‚¬ ëª…ë‹¨
        match /members/{memberId} {
          allow read: if isSignedIn();
          allow create, update: if isSignedIn(); // ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì (í˜„ì¬ëŠ” ëˆ„êµ¬ë‚˜ í—ˆìš©)
          allow delete: if isSignedIn(); // ê´€ë¦¬ì/í”Œë˜ë„ˆ ê¶Œí•œìš©
        }

        // 7.2.1-1 del_members: íœ´ì§€í†µ
        match /del_members/{memberId} {
          allow read, write: if isSignedIn();
        }

        // 7.2.2 Mass Events: ë¯¸ì‚¬ ì¼ì •
        match /mass_events/{eventId} {
          allow read: if isSignedIn();
          allow write: if isSignedIn();
        }

        // 7.2.3 Role Requests: ê¶Œí•œ ì‹ ì²­
        match /role_requests/{requestId} {
          allow read, write: if isSignedIn();
        }
        
        // 7.2.4 Month Status: ì›”ë³„ ìƒíƒœ
        match /month_status/{statusId} {
          allow read, write: if isSignedIn();
        }

        // 7.2.5 Availability Surveys: ê°€ìš©ì„± ì„¤ë¬¸
        match /availability_surveys/{yyyymm} {
          allow read, write: if isSignedIn();
          match /responses/{memberId} {
            allow read, write: if isSignedIn();
          }
        }

        // 7.2.6 AI Insights: AI ë¶„ì„ ê²°ê³¼
        match /ai_insights/{yyyymm} {
          allow read, write: if isSignedIn();
          match /history/{docId} {
            allow read, write: if isSignedIn();
          }
        }

        // 7.2.7 Auto Assign Logs: ìë™ë°°ì • ë¡œê·¸
        match /auto_assign_logs/{yyyymm} {
          allow read, write: if isSignedIn();
        }

        // 7.2.8 Mass Presets: ë¯¸ì‚¬ í”„ë¦¬ì…‹
        match /mass_presets/{presetId} {
          allow read, write: if isSignedIn();
        }
      }

      // 7.3 Counters: ì±„ë²ˆ ì¹´ìš´í„°
      match /counters/{counterId} {
        allow read, write: if isSignedIn();
      }
      
      // 7.4 Settings: ì•± ì„¤ì •
      match /settings/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
      }
    }

    // 7.2.1+ Collection Group Rules: members (ì „ì²´ ê²½ë¡œ ëŒ€ì‘)
    match /{path=**}/members/{memberId} {
      allow read: if isSignedIn(); 
    }

    // 7.2.3+ Collection Group Rules: role_requests (ì „ì²´ ê²½ë¡œ ëŒ€ì‘)
    match /{path=**}/role_requests/{requestId} {
      allow read: if isSignedIn() && (requestId == request.auth.uid || isSuperAdmin());
    }

    // 8ï¸âƒ£ ë‚˜ë¨¸ì§€: ê¸°ë³¸ ì°¨ë‹¨ (ëª…ì‹œë˜ì§€ ì•Šì€ ê²½ë¡œëŠ” ì ‘ê·¼ ë¶ˆê°€)
  }
}
