# PRD-2.5.1 CopyPrevMonthMassEvents Logic (ì „ì›” ë¯¸ì‚¬ì¼ì • ë³µì‚¬)

## ğŸ§© 1. ì„¹ì…˜ ê°œìš”

ë³¸ ì„¹ì…˜ì€ í”Œë˜ë„ˆ(Planner)ê°€ ì°¨ì›”ì˜ ë¯¸ì‚¬ ì¼ì • ì´ˆê¸° ì„¤ì • ì‹œ
ì´ì „ ë‹¬ì˜ ìš”ì¼ íŒ¨í„´(base)ì„ ê¸°ë°˜ìœ¼ë¡œ ì „ì²´ ì¼ì •ì„ ìë™ ë³µì‚¬í•˜ëŠ” Cloud Function ë¡œì§ì„ ì •ì˜í•œë‹¤.

## ğŸ§© 2. ì£¼ìš” ëª©í‘œ

| í•­ëª©           | ì„¤ëª…                                          |
| ------------ | ------------------------------------------- |
| âš™ï¸ ìë™í™” ëª©ì     | ë§¤ë‹¬ ë°˜ë³µë˜ëŠ” ì¼ì •(í‰ì¼/ì£¼ì¼ ë¯¸ì‚¬ ë“±)ì„ ìˆ˜ì‘ì—… ì—†ì´ ìë™ ë³µì‚¬        |
| ğŸ“… ê¸°ì¤€ ì£¼ì°¨     | â€œì „ì›”ì˜ **ì²« ë²ˆì§¸ ì¼ìš”ì¼ì´ í¬í•¨ëœ ì£¼(ì¼~í† )**â€ ì˜ íŒ¨í„´(base)ì„ ê¸°ì¤€ìœ¼ë¡œ í•¨ |
| ğŸ” ë³µì‚¬ ë°©ì‹     | ë³µì‚¬ ë‹¹ì›” 1ì¼ë¶€í„° ë§ì¼ê¹Œì§€ ëŒë©´ì„œ ë™ì¼ ìš”ì¼ì˜ ì „ì›” íŒ¨í„´(base)ì„ ë§¤ì¹­ ë³µì‚¬        |
| ğŸ’¾ ë°ì´í„° íƒ€ì…    | `event_date: string("YYYYMMDD")`            |
| ğŸ”’ ìƒíƒœ ì œì•½     | `month_status != MASS-NOTCONFIRMED` ìƒíƒœì—ì„œ ë³µì‚¬ ê°€ëŠ¥ |
| ğŸ•’ ì‹œê°„ ê¸°ì¤€     | Asia/Seoul (UTC+9) ë‹¨ì¼ ê¸°ì¤€, timezone ë³€í™˜ ì—†ìŒ    |
| ğŸ§¹ ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬ | ë³µì‚¬ ë‹¹ì›” ì¼ì •(`mass_events`)ì„ ëª¨ë‘ ì‚­ì œ í›„ ìƒˆ ì¼ì •ìœ¼ë¡œ êµì²´ (ì‚¬ì „ê²½ê³  í•„ìš”) |

## ğŸ§© 3. ë™ì‘ ì‹œë‚˜ë¦¬ì˜¤

1ï¸âƒ£ í”Œë˜ë„ˆê°€ MassEventPlanner Toolbarì—ì„œ [ì „ì›” ë¯¸ì‚¬ì¼ì • ë³µì‚¬] ë²„íŠ¼ í´ë¦­
2ï¸âƒ£ Drawer ëª¨ë‹¬ì—ì„œ í™•ì¸ í›„ â€œë³µì‚¬ ì‹œì‘â€ ë²„íŠ¼ í´ë¦­
    + ì´ì „ë°ì´í„° ì‚­ì œ ê²½ê³  ë©”ì„¸ì§€("ì „ì›” ë¯¸ì‚¬ì¼ì • ê°€ì ¸ì˜¤ê¸°ë¥¼ í•˜ë©´ ì„ íƒëœ ì›”ì— ì…ë ¥ëœ ë¯¸ì‚¬ì¼ì •ê³¼ ë³µì‚¬ì„¤ë¬¸ ì •ë³´ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤")
3ï¸âƒ£ Cloud Function copyPrevMonthMassEvents í˜¸ì¶œ
4ï¸âƒ£ ì „ì›” month_status/{prevMonth}.status MASS-NOTCONFIRMED ì²´í¬(MASS-NOTCONFIRMEDê°€ ì•„ë‹Œ ìƒíƒœì—ì„œë§Œ í—ˆìš©)
5ï¸âƒ£ ì „ì›” ê¸°ì¤€ ì£¼ê°„(ì²« ì¼ìš”ì¼ í¬í•¨ ì£¼)ì˜ ë¯¸ì‚¬ íŒ¨í„´ì„ ìš”ì¼ë³„ ë°°ì—´(base)ë¡œ ì €ì¥
6ï¸âƒ£ ë‹¹ì›” 1ì¼ë¶€í„° ë§ì¼ê¹Œì§€ loop, ê° ë‚ ì§œì˜ ìš”ì¼ day()ë¡œ base[dow] ë§¤ì¹­
7ï¸âƒ£ ë™ì¼ ìš”ì¼ì˜ ë¯¸ì‚¬ ì´ë²¤íŠ¸ë“¤ì„ ê·¸ëŒ€ë¡œ ë³µì œ (title, required_servers ìœ ì§€)
8ï¸âƒ£ ë³µì‚¬ ì™„ë£Œ í›„ ok:true, ë³µì‚¬ ê±´ìˆ˜ ë°˜í™˜

### 3.1 ì£¼ìš” ë³µì‚¬ë¡œì§

  . ë‚ ì§œ ë‹¨ìœ„ë¡œ ì¼ë³„ ë³µì‚¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
  . ì „ì›” ì²«ë²ˆì§¸ ì¼ìš”ì¼ì—ì„œ í™”/ìˆ˜/ëª©/ê¸ˆ/í† ìš”ì¼ê¹Œì§€ì˜ 7ì¼ì¹˜ ìš”ì¼ë³„ ë¯¸ì‚¬ì¼ì •ë°°ì—´ base ë¥¼ ì €ì¥í•˜ê³  ë‚œë’¤ì—,
    (ì£¼ëŠ” ì¼/ì›”/í™”/ìˆ˜/ëª©/ê¸ˆ/í†  ìˆœì„œì„)
  . ë‹¹ì›”ì˜ 1ì¼ë¶€í„° ë§ì¼ê¹Œì§€ loop ëŒë©´ì„œ í•´ë‹¹ìš”ì¼ì´ baseë°°ì—´ì— ìˆëŠ” ë¯¸ì‚¬ì¼ì •ì„ ë³µì‚¬í•˜ë©´ ë¨.
  . ì˜ˆë¥¼ ë“¤ì–´ ë‹¹ì›” 1ì¼ì´ í† ìš”ì¼ì´ë©´ ì „ì›” base[í† ]ì— ìˆëŠ” ë¯¸ì‚¬ì¼ì •ì„ ë‹¨ìˆœíˆ ë³µì‚¬í•´ ë‚˜ê°€ë©´ ë¨.

## ğŸ§© 4. Firestore ê²½ë¡œ

| ì»¬ë ‰ì…˜                    | ê²½ë¡œ                                          | ì„¤ëª…                                        |
| ---------------------- | ------------------------------------------- | ----------------------------------------- |
| `mass_events`          | `server_groups/{sg}/mass_events/{event_id}` | ë³µì‚¬ ëŒ€ìƒ ë° ê²°ê³¼ ì €ì¥                             |
| `month_status`         | `server_groups/{sg}/month_status/{yyyymm}`  | ìƒíƒœ ê²€ì¦                                     |

## ğŸ§© 5. Cloud Function ì‚¬ì–‘

| í•­ëª©      | ê°’                                                 |
| ------- | ------------------------------------------------- |
| í•¨ìˆ˜ëª…     | `copyPrevMonthMassEvents`                         |
| íƒ€ì…      | Callable Function                                 |
| ìœ„ì¹˜      | `functions/src/massEvents/copyPrevMonth.ts`       |
| ë¦¬ì „      | `asia-northeast3 (Seoul)`                         |
| ê¶Œí•œ      | planner role ì „ìš©                                   |
| ìš”ì²­ íŒŒë¼ë¯¸í„° | `{ serverGroupId: string; currentMonth: string }` |
| ì‘ë‹µ      | `{ ok: boolean; message: string }`                |

## ğŸ§© 6. ì£¼ìš” ë¡œì§ íë¦„ (ìš”ì•½)

```tsx
  // ğŸ”¹ 1. ìœ íš¨ì„± ê²€ì¦
  if (!auth) throw new Error("unauthenticated");
  if (!serverGroupId || !currentMonth) throw new Error("invalid arguments");

  // ğŸ”¹ 2. ì „ì›” ìƒíƒœ í™•ì¸
  const prevMonth = dayjs(currentMonth).subtract(1, "month");
  const statusDoc = await getDoc(`server_groups/${sg}/month_status/${prevMonthKey}`);
  if (statusDoc.data()?.status !== "MASS-CONFIRMED") return { ok:false, message:"ì „ì›” ìƒíƒœ ì˜¤ë¥˜" };

  // ğŸ”¹ 3. ë‹¹ì›” ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
  await deleteAll(`server_groups/${sg}/mass_events` where event_date between currentMonthStart~End);

  // ğŸ”¹ 4. ê¸°ì¤€ ì£¼ê°„ íŒ¨í„´ ì¶”ì¶œ
  let firstSunday = prevMonth.startOf("month");
  while (firstSunday.day() !== 0) firstSunday = firstSunday.add(1, "day");
  const baseStart = firstSunday, baseEnd = firstSunday.add(6, "day");
  const baseSnap = await query(mass_events, where event_date between baseStart~baseEnd);

  // ğŸ”¹ 5. ìš”ì¼ë³„ base ì €ì¥
  base[dow] = [title, required_servers];

  // ğŸ”¹ 6. ë‹¹ì›” 1ì¼ë¶€í„° ë§ì¼ê¹Œì§€ ë³µì‚¬
  for each day in currentMonth:
    dow = day.day()
    if base[dow] exists â†’ mass_events.add({
        title, required_servers, event_date: day.format("YYYYMMDD")
    })
```

## ğŸ§© 7. ë°ì´í„° ë³µì‚¬ ì˜ˆì‹œ

- ì˜ˆë¥¼ë“¤ì–´, 9ì›”ê³¼ 10ì›” ë‹¬ë ¥ì´ ì•„ë˜ì™€ ê°™ì„ë•Œ, ì „ì›”(9ì›”)ì—ì„œ 10ì›”ë¡œ ë¯¸ì‚¬ì¼ì •ë³µì‚¬ ë¡œì§ì— ëŒ€í•œ ì˜ˆë¥¼ ë“¤ê² ë‹¤.

```lua
        2025ë…„ 9ì›”
ì¼  ì›”  í™”  ìˆ˜  ëª©  ê¸ˆ  í† 
--------------------------
    1   2   3   4   5   6
 7  8   9  10  11  12  13
14 15  16  17  18  19  20
21 22  23  24  25  26  27
28 29  30
--------------------------

        2025ë…„ 10ì›”
ì¼  ì›”  í™”  ìˆ˜  ëª©  ê¸ˆ  í† 
--------------------------
             1   2   3   4
 5   6   7   8   9  10  11
12  13  14  15  16  17  18
19  20  21  22  23  24  25
26  27  28  29  30  31
--------------------------
```

- ì „ì›”(9ì›”) ê¸°ì¤€(base) ì£¼ê°„ì€ ì²«ë²ˆì§¸ ì¼ìš”ì¼ì¸ 9ì›”7ì¼ ~ 9ì›”13ì¼(í† )ì´ ëœë‹¤.

```lua
| ìš”ì¼ | event_date | mass event titles       | required_servers |
| -- | ---------- | ------------------------- | ---------------- |
| ì¼  | 20250907   | ì£¼ì¼ 10ì‹œ ë¯¸ì‚¬, ì£¼ì¼ë°¤ë¯¸ì‚¬   | 3, 2            |
| ìˆ˜  | 20250910   | í‰ì¼ ìˆ˜ ë¯¸ì‚¬1, í‰ì¼ ìˆ˜ ë¯¸ì‚¬2 | 2, 1            |
| ê¸ˆ  | 20250912   | í‰ì¼ ê¸ˆ ë¯¸ì‚¬               | 2               |
```

- ë‹¹ì›”(10ì›”) ë³µì‚¬ ê²°ê³¼

```lua
| ë‚ ì§œ   | ìš”ì¼ | ë³µì‚¬ëœ ì´ë²¤íŠ¸             |
| ----- | -- | ------------------- |
| 10/1  | ìˆ˜  | í‰ì¼ ìˆ˜ ë¯¸ì‚¬1, í‰ì¼ ìˆ˜ ë¯¸ì‚¬2 |
| 10/3  | ê¸ˆ  | í‰ì¼ ê¸ˆ ë¯¸ì‚¬             |
| 10/5  | ì¼  | ì£¼ì¼ 10ì‹œ ë¯¸ì‚¬, ì£¼ì¼ë°¤ë¯¸ì‚¬ |
| 10/12 | ì¼  | ì£¼ì¼ 10ì‹œ ë¯¸ì‚¬, ì£¼ì¼ë°¤ë¯¸ì‚¬  |
| 10/15 | ìˆ˜  | í‰ì¼ ìˆ˜ ë¯¸ì‚¬1, í‰ì¼ ìˆ˜ ë¯¸ì‚¬2 |
| 10/17 | ê¸ˆ  | í‰ì¼ ê¸ˆ ë¯¸ì‚¬              |
```

## ğŸ§© 8. ì˜ˆì™¸ ë° ì˜¤ë¥˜ ì²˜ë¦¬

| ìƒí™©                    | ë©”ì‹œì§€                                 |
| --------------------- | ----------------------------------- |
| `month_status` ì—†ìŒ     | â€œì „ì›” ìƒíƒœ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.â€              |
| ìƒíƒœ = `MASS-NOTCONFIRMED` | â€œì „ì›” ìƒíƒœê°€ 'ë¯¸í™•ì •'ì¸ ê²½ìš° ë³µì‚¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.â€  |
| ê¸°ì¤€ ì£¼ê°„ ë°ì´í„° ì—†ìŒ          | â€œì „ì›” ê¸°ì¤€ ì£¼ê°„ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.â€                |
| ë³µì‚¬ ì„±ê³µ                 | â€œâœ… 9ì›” ì²«ì§¸ ì£¼ íŒ¨í„´ì„ 10ì›” ì „ì²´ì— ë³µì‚¬ ì™„ë£Œ (24ê±´)â€ |

## ğŸ§© 9. UI ì—°ë™ (CopyPrevMonthDrawer)

| êµ¬ë¶„    | ë‚´ìš©                                                       |
| ----- | -------------------------------------------------------- |
| ìœ„ì¹˜    | `/src/pages/components/CopyPrevMonthDrawer.tsx`          |
| ë²„íŠ¼    | Toolbar â†’ â€œì „ì›” ë¯¸ì‚¬ì¼ì • ë³µì‚¬â€                                   |
| í™•ì¸ ëª¨ë‹¬ | ì „ì›”ê³¼ ë‹¹ì›” í‘œì‹œ, ì£¼ì˜ ë¬¸êµ¬(ë‹¹ì›” ì¼ì • ì‚­ì œë¨)                              |
| ì‹¤í–‰    | `httpsCallable(functions, "copyPrevMonthMassEvents")` í˜¸ì¶œ |
| ì™„ë£Œ í›„  | Toast: â€œë³µì‚¬ ì™„ë£Œ! ìƒˆ ë‹¬ë ¥ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.â€ + ìº˜ë¦°ë” ë¦¬í”„ë ˆì‹œ                |

## ğŸ§© 10. ì—°ê³„ ë¬¸ì„œ

| ê´€ë ¨ ì„¹ì…˜                        | íŒŒì¼                                    |
| ---------------------------- | ------------------------------------- |
| 2.4.2 ë¯¸ì‚¬ ì¼ì • ê´€ë¦¬               | `PRD-Main-Altar Scheduler.md`         |
| 2.4.7 MassEvent Calendar UI  | `PRD-2.4.7-MassEvent Calendar UI.md`  |
| 2.4.8 MassEvent Planner UI   | `PRD-2.4.8-MassEvent Planner UI.md`   |
| 2.13 App UI & UX             | `PRD-2.13-App-UIUX.md`                |
| 3.4.1 Firebase Setup         | `PRD-3.4.1-Firebase Setup.md`         |
| 3.4.2 Firestore doc Modeling | `PRD-3.4.2-Firestore doc Modeling.md` |

---
